<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="detailPageTitle">Chi ti·∫øt T√†i li·ªáu</title>
  <link id="theme-style" rel="stylesheet" href="style.css">

  <style>
    /* ===== PH·∫¶N C≈® C·ª¶A B·∫†N (GI·ªÆ NGUY√äN) ===== */
    .container {
      max-width: 1200px;
      margin: 80px auto 40px;
      padding: 20px;
    }
    h1 { color: #2c3e50; margin-bottom: 20px; }

    .back-btn {
      position: fixed;
      top: 80px;
      left: 40px;
      z-index: 1000;
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }

    #fileDetailGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
      padding: 20px;
      background: #f4f6f9;
      border-radius: 12px;
    }

    .file-card-detail {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }

    .preview-img-detail {
      width: 100%;
      height: 150px;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 15px;
      background: #ecf0f1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    /* ===== MODAL C≈® ===== */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 2000;
    }

    .modal-content {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
    }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 32px;
      color: white;
      cursor: pointer;
      z-index: 3000;
    }

    .modal-body-content {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    /* ===== PH·∫¶N TH√äM (KH√îNG ·∫¢NH H∆Ø·ªûNG C≈®) ===== */

    .zoomable {
      max-width: 100%;
      max-height: 100%;
      cursor: grab;
      transition: transform 0.15s ease;
      will-change: transform;
    }
    .zoomable.dragging {
      cursor: grabbing;
      transition: none;
    }

    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 40px;
      color: white;
      cursor: pointer;
      z-index: 3000;
      padding: 10px 14px;
      background: rgba(0,0,0,0.4);
      border-radius: 50%;
      user-select: none;
    }
    .left-arrow { left: 20px; }
    .right-arrow { right: 20px; }

    .image-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 600;
      z-index: 3000;
    }
  </style>
</head>

<script src="snow.js"></script>

<body>
  <!-- NAVBAR GI·ªÆ NGUY√äN -->
  <div id="navbar"></div>

  <button class="back-btn" onclick="window.location.href='doc.html'">‚¨ÖÔ∏è Quay l·∫°i</button>

  <script type="module">
    fetch("nav.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("navbar").innerHTML = html;
        import('./nav.js');
      });
  </script>

  <div class="container">
    <h1 id="detailHeader">T√†i li·ªáu chi ti·∫øt</h1>
    <div id="fileDetailGrid">
      <p>ƒêang t·∫£i t√†i li·ªáu...</p>
    </div>
  </div>

  <!-- MODAL (CH·ªà TH√äM ARROW + COUNTER) -->
  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>

      <div class="nav-arrow left-arrow">‚ùÆ</div>
      <div class="nav-arrow right-arrow">‚ùØ</div>
      <div class="image-counter" id="imageCounter"></div>

      <div id="modalBody" class="modal-body-content"></div>
    </div>
  </div>

  <script type="module">
    import { db, doc, onSnapshot } from "./firebase.js";

    const folderId = new URLSearchParams(window.location.search).get('id');
    const detailHeaderEl = document.getElementById('detailHeader');
    const fileDetailGridEl = document.getElementById('fileDetailGrid');
    const modal = document.getElementById("myModal");
    const modalBodyEl = document.getElementById("modalBody");
    const counterEl = document.getElementById("imageCounter");

    let imageFiles = [];
    let currentIndex = 0;
    let scale = 1;

    document.querySelector(".close-btn").onclick = () => {
      modal.style.display = "none";
      modalBodyEl.innerHTML = "";
    };

    onSnapshot(doc(db, "docs", folderId), snap => {
      if (!snap.exists()) return;
      const data = snap.data();
      const files = data.files || [];
      imageFiles = files.filter(f => f.type?.startsWith("image/"));
      renderFilesDetail(files);
    });

    function renderFilesDetail(files) {
      fileDetailGridEl.innerHTML = '';
      files.forEach(file => {
        const card = document.createElement('div');
        card.className = 'file-card-detail';
        card.innerHTML = `
          <div class="preview-img-detail">
            ${file.type.startsWith('image/') ? `<img src="${file.url}" style="width:100%;height:100%;object-fit:contain">` : file.name.split('.').pop()}
          </div>
          <h4>${file.name}</h4>
          <a href="#">üëÅÔ∏è Xem tr∆∞·ªõc</a>
        `;
        card.querySelector('a').onclick = e => {
          e.preventDefault();
          openFile(file);
        };
        fileDetailGridEl.appendChild(card);
      });
    }

    function openFile(file) {
      modalBodyEl.innerHTML = '';
      scale = 1;

      if (file.type.startsWith('image/')) {
        currentIndex = imageFiles.findIndex(f => f.url === file.url);
        modalBodyEl.innerHTML = `<img src="${file.url}" class="zoomable" id="zoomImg">`;
        setupImageControls();
        updateCounter();
        toggleNav(true);
      }

      modal.style.display = "block";
    }

function setupImageControls() {
  const img = document.getElementById("zoomImg");

  let posX = 0, posY = 0;
  let startX = 0, startY = 0;
  let lastX = 0, lastY = 0;
  let velX = 0, velY = 0;
  let dragging = false;
  let inertiaId = null;

  const apply = () => {
    img.style.transform =
      `translate(${posX}px, ${posY}px) scale(${scale})`;
  };

  const clamp = () => {
    const rect = img.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    const limitX = Math.max(0, (rect.width - vw) / 2);
    const limitY = Math.max(0, (rect.height - vh) / 2);

    posX = Math.min(limitX, Math.max(-limitX, posX));
    posY = Math.min(limitY, Math.max(-limitY, posY));
  };

  /* ===== ZOOM THEO CON TR·ªé ===== */
  img.addEventListener("wheel", e => {
    e.preventDefault();
    const r = img.getBoundingClientRect();
    img.style.transformOrigin =
      `${((e.clientX - r.left) / r.width) * 100}% ${((e.clientY - r.top) / r.height) * 100}%`;

    scale = Math.min(Math.max(1, scale + e.deltaY * -0.001), 4);
    clamp();
    apply();
  }, { passive: false });

  /* ===== NH·∫§N GI·ªÆ ‚Üí K√âO ===== */
  img.addEventListener("mousedown", e => {
    if (scale === 1) return;          // ch∆∞a zoom th√¨ kh√¥ng k√©o
    dragging = true;
    img.classList.add("dragging");

    startX = lastX = e.clientX;
    startY = lastY = e.clientY;

    velX = velY = 0;
    cancelAnimationFrame(inertiaId);
  });

  /* ===== ƒêANG GI·ªÆ CHU·ªòT ===== */
  window.addEventListener("mousemove", e => {
    if (!dragging) return;

    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;

    posX += dx;
    posY += dy;

    velX = dx;
    velY = dy;

    lastX = e.clientX;
    lastY = e.clientY;

    clamp();
    apply();
  });

  /* ===== TH·∫¢ CHU·ªòT ‚Üí D·ª™NG ===== */
  window.addEventListener("mouseup", () => {
    if (!dragging) return;

    dragging = false;
    img.classList.remove("dragging");

    // inertia nh·∫π cho ƒë√£ tay
    const friction = 0.92;
    const inertia = () => {
      velX *= friction;
      velY *= friction;

      posX += velX;
      posY += velY;

      clamp();
      apply();

      if (Math.abs(velX) > 0.3 || Math.abs(velY) > 0.3) {
        inertiaId = requestAnimationFrame(inertia);
      }
    };
    inertia();
  });
}

    document.querySelector(".left-arrow").onclick = () => changeImage(-1);
    document.querySelector(".right-arrow").onclick = () => changeImage(1);

    function changeImage(step) {
      currentIndex = (currentIndex + step + imageFiles.length) % imageFiles.length;
      openFile(imageFiles[currentIndex]);
    }

    function updateCounter() {
      counterEl.textContent = `${currentIndex + 1} / ${imageFiles.length}`;
    }

    function toggleNav(show) {
      document.querySelector(".left-arrow").style.display = show ? "block" : "none";
      document.querySelector(".right-arrow").style.display = show ? "block" : "none";
      counterEl.style.display = show ? "block" : "none";
    }
  </script>
</body>
</html>
