<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Th·ªùi kh√≥a bi·ªÉu</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- NAVBAR -->
  <div id="navbar"></div>
  <script>
    fetch("nav.html")
      .then(res => res.text())
      .then(html => document.getElementById("navbar").innerHTML = html);
  </script>
  <script type="module" src="nav.js"></script>

  <div class="container">
    <h1>üìÖ Th·ªùi kh√≥a bi·ªÉu</h1>

    <!-- Hi·ªÉn th·ªã cho m·ªçi ng∆∞·ªùi -->
    <div id="display">‚è≥ ƒêang t·∫£i...</div>

    <!-- Ch·ªâ admin m·ªõi th·∫•y -->
    <div id="adminPanel" style="display:none; margin-top:20px;">
      <textarea id="tkb" placeholder="Nh·∫≠p th·ªùi kh√≥a bi·ªÉu..." style="width:100%;height:150px;"></textarea><br>

      <!-- Upload ·∫£nh -->
      <input type="file" id="fileInput" accept="image/*"><br>
      <img id="preview" style="max-width:200px;margin-top:10px;display:none;border-radius:10px;">
      <br>

      <button id="save" style="margin-top:10px;">üíæ L∆∞u</button>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const CLOUD_NAME = "dmxz0m1x3"; // ‚ö†Ô∏è thay b·∫±ng cloud name c·ªßa m√†y
    const UPLOAD_PRESET = "8a1_upload"; // ‚ö†Ô∏è thay b·∫±ng upload preset (c√¥ng khai)

    const display = document.getElementById("display");
    const tkbDoc = await getDoc(doc(db, "data", "timetable"));

    if (tkbDoc.exists()) {
      const data = tkbDoc.data();
      display.innerHTML = `
        <p>${data.content || "Ch∆∞a c√≥ d·ªØ li·ªáu."}</p>
        ${data.image ? `<img src="${data.image}" style="max-width:100%;border-radius:10px;margin-top:10px;">` : ""}
      `;
    } else {
      display.innerText = "Ch∆∞a c√≥ th·ªùi kh√≥a bi·ªÉu.";
    }

    // üîí Ch·ªâ admin m·ªõi ƒë∆∞·ª£c ch·ªânh s·ª≠a
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (userDoc.exists() && userDoc.data().role === "admin") {
        document.getElementById("adminPanel").style.display = "block";
      }

      let uploadedUrl = null;

      // Xem tr∆∞·ªõc ·∫£nh
      const fileInput = document.getElementById("fileInput");
      const preview = document.getElementById("preview");
      fileInput.onchange = () => {
        const file = fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      };

      // Upload + l∆∞u d·ªØ li·ªáu
      document.getElementById("save").onclick = async () => {
        const content = document.getElementById("tkb").value.trim();
        const file = fileInput.files[0];

        if (file) {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("upload_preset", UPLOAD_PRESET);

          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
            method: "POST",
            body: formData
          });
          const data = await res.json();
          uploadedUrl = data.secure_url;
        }

        await setDoc(doc(db, "data", "timetable"), { 
          content,
          image: uploadedUrl || (tkbDoc.data()?.image || null)
        });

        alert("‚úÖ ƒê√£ l∆∞u th·ªùi kh√≥a bi·ªÉu!");
        location.reload();
      };
    });
  </script>
</body>
</html>
