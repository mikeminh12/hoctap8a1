<!DOCTYPE html>
<html lang="vi">
<head>
Â  <meta charset="UTF-8">
Â  <title>Thá»i khÃ³a biá»ƒu</title>
  <link id="theme-style" rel="stylesheet" href="style.css">
  <script src="snow.js"></script>
Â  <style>
Â  Â  /* Style riÃªng cho nÃºt xÃ³a dá»¯ liá»‡u admin */
Â  Â  #delete-btn {
Â  Â  Â  Â  background: #e74c3c !important; /* Äá» */
Â  Â  Â  Â  box-shadow: 0 4px 6px rgba(231, 76, 60, 0.3) !important;
Â  Â  Â  Â  margin-left: 10px;
Â  Â  }
Â  Â  #delete-btn:hover {
Â  Â  Â  Â  background: #c0392b !important;
Â  Â  Â  Â  box-shadow: 0 6px 10px rgba(231, 76, 60, 0.4) !important;
Â  Â  }
Â  Â  /* Khung hiá»ƒn thá»‹ TKB dáº¡ng vÄƒn báº£n */
Â  Â  .tkb-content-box {
Â  Â  Â  Â  white-space: pre-line; 
Â  Â  Â  Â  line-height: 1.8; 
Â  Â  Â  Â  font-size: 1.05rem; 
Â  Â  Â  Â  background: #fff; 
Â  Â  Â  Â  padding: 20px; 
Â  Â  Â  Â  border-radius: var(--border-radius-md); 
Â  Â  Â  Â  border: 1px solid var(--color-border);
Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
Â  Â  }
Â  Â  /* ğŸ”¥ áº¢nh TKB (Hiá»ƒn thá»‹) - ÄÃ£ FIX trÃ n khung */
Â  Â  #display img {
Â  Â  Â  Â  **display: block;**
Â  Â  Â  Â  **width: 100%;** Â  Â  Â  Â  **height: auto;** Â  Â  Â  Â  border-radius: var(--border-radius-md); 
Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
Â  Â  Â  Â  border: 1px solid var(--color-border);
Â  Â  }
    /* áº¢nh Preview (Admin Panel) */
    #preview {
        max-width: 300px; /* Giá»›i háº¡n chiá»u rá»™ng vá»«a pháº£i cho khu vá»±c admin */
        width: 100%;
        height: auto;
        margin-top: 10px;
        border-radius: 10px;
        border: 1px solid #ddd;
    }
Â  </style>
</head>
<body>
Â  <div id="navbar"></div>

Â  <script type="module">
Â  Â  // ğŸ”¥ Load nav.html trÆ°á»›c, rá»“i má»›i load nav.js
Â  Â  fetch("nav.html")
Â  Â  Â  .then(res => res.text())
Â  Â  Â  .then(html => {
Â  Â  Â  Â  document.getElementById("navbar").innerHTML = html;
Â  Â  Â  Â  import('./nav.js');
Â  Â  Â  });
Â  </script>

  <div id="toast-container" class="toast-container"></div> 

Â  <div class="container"> 
Â  Â  <h1>ğŸ“… Thá»i khÃ³a biá»ƒu</h1>

Â  Â  <div id="display">â³ Äang táº£i...</div>

Â  Â  <div id="adminPanel" style="display:none; margin-top:20px;">
Â  Â  Â  <hr>
Â  Â  Â  <p style="font-weight: 600;">Panel quáº£n lÃ½ (Admin)</p>
Â  Â  Â  
Â  Â  Â  <textarea id="tkb" placeholder="Nháº­p thá»i khÃ³a biá»ƒu..."></textarea>
Â  Â  Â  
Â  Â  Â  <label style="display:block;margin-bottom:8px;font-weight:500;">ğŸ“· áº¢nh thá»i khÃ³a biá»ƒu (Æ°u tiÃªn áº£nh):</label>
Â  Â  Â  
Â  Â  Â  <input type="file" id="fileInput" accept="image/*">
Â  Â  Â  
Â  Â  Â  <img id="preview" style="display:none;" alt="áº¢nh xem trÆ°á»›c TKB">
Â  Â  Â  <br>

Â  Â  Â  <button id="save">ğŸ’¾ LÆ°u Thá»i KhÃ³a Biá»ƒu</button> 
Â  Â  Â  <button id="delete-btn">âŒ XÃ³a Dá»¯ Liá»‡u TKB</button>
Â  Â  </div>
Â  </div>

Â  <script type="module">
Â  Â  import { db, auth } from './firebase.js';
Â  Â  import { doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
Â  Â  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
Â  Â  
Â  Â  // ğŸ”¥ Thay tháº¿ báº±ng thÃ´ng tin Cloudinary cá»§a báº¡n
Â  Â  const CLOUD_NAME = "dmxz0m1x3"; 
Â  Â  const UPLOAD_PRESET = "8a1_upload";

    // ğŸ’¡ HÃ€M HIá»‚N THá»Š TOAST Má»šI ğŸ’¡
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = '';
        if (type === 'success') {
            icon = 'âœ…';
        } else if (type === 'error') {
            icon = 'âŒ';
            toast.style.borderLeftColor = '#e74c3c'; 
        } else if (type === 'info') {
            icon = 'â„¹ï¸';
            toast.style.borderLeftColor = '#3498db'; 
        }
        
        toast.innerHTML = `<span>${icon}</span> ${message}`;
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10); 

        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => {
                toast.remove();
            });
        }, 3000);
    }
    // ğŸ’¡ Káº¾T THÃšC HÃ€M TOAST ğŸ’¡
Â  Â  
Â  Â  // ğŸ”¥ Load TKB
Â  Â  async function loadTimetable() {
Â  Â  Â  const docRef = doc(db, "data", "timetable");
Â  Â  Â  const docSnap = await getDoc(docRef);
Â  Â  Â  const displayEl = document.getElementById("display");

Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  const data = docSnap.data();
Â  Â  Â  Â  if (data.image) {
Â  Â  Â  Â  Â  displayEl.innerHTML = `<img src="${data.image}" alt="Thá»i khÃ³a biá»ƒu">`;
Â  Â  Â  Â  } else if (data.content) {
Â  Â  Â  Â  Â  // DÃ¹ng class má»›i cho khung TKB dáº¡ng text
Â  Â  Â  Â  Â  displayEl.innerHTML = `<div class="tkb-content-box">${data.content}</div>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â displayEl.innerHTML = "<p>ChÆ°a cÃ³ thá»i khÃ³a biá»ƒu Ä‘Æ°á»£c cáº­p nháº­t!</p>";
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  displayEl.innerHTML = "<p>ChÆ°a cÃ³ thá»i khÃ³a biá»ƒu Ä‘Æ°á»£c cáº­p nháº­t!</p>";
Â  Â  Â  }
Â  Â  }

Â  Â  loadTimetable();

Â  Â  // ===== ADMIN PANEL LOGIC =====
Â  Â  let tkbData = null; // Cache data
Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  if (!user) return;

Â  Â  Â  // ğŸ”’ Kiá»ƒm tra quyá»n admin
Â  Â  Â  const userDoc = await getDoc(doc(db, "users", user.uid));
Â  Â  Â  if (userDoc.exists() && userDoc.data().role === "admin") {
Â  Â  Â  Â  document.getElementById("adminPanel").style.display = "block";
Â  Â  Â  } else {
Â  Â  Â  Â  return; // KhÃ´ng pháº£i admin thÃ¬ dá»«ng
Â  Â  Â  }

Â  Â  Â  // Load data vÃ o admin panel
Â  Â  Â  const tkbRef = doc(db, "data", "timetable");
Â  Â  Â  const tkbSnap = await getDoc(tkbRef);
Â  Â  Â  if (tkbSnap.exists()) {
Â  Â  Â  Â  tkbData = tkbSnap.data();
Â  Â  Â  Â  document.getElementById("tkb").value = tkbData.content || "";
Â  Â  Â  Â  if (tkbData.image) {
Â  Â  Â  Â  Â  document.getElementById("preview").src = tkbData.image;
Â  Â  Â  Â  Â  document.getElementById("preview").style.display = "block";
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  let uploadedUrl = null;

Â  Â  Â  // Xem trÆ°á»›c áº£nh
Â  Â  Â  const fileInput = document.getElementById("fileInput");
Â  Â  Â  const preview = document.getElementById("preview");
Â  Â  Â  fileInput.onchange = () => {
Â  Â  Â  Â  const file = fileInput.files[0];
Â  Â  Â  Â  if (!file) {
            preview.style.display = "none";
            preview.src = "";
            return;
        }
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = e => {
Â  Â  Â  Â  Â  preview.src = e.target.result;
Â  Â  Â  Â  Â  preview.style.display = "block";
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  };

Â  Â  Â  // Upload + lÆ°u dá»¯ liá»‡u
Â  Â  Â  document.getElementById("save").onclick = async () => {
Â  Â  Â  Â  const content = document.getElementById("tkb").value.trim();
Â  Â  Â  Â  const file = fileInput.files[0];
        
        // Cáº£nh bÃ¡o náº¿u khÃ´ng cÃ³ ná»™i dung/áº£nh
        if (!content && !file && (!tkbData || (!tkbData.content && !tkbData.image))) {
             showToast("Vui lÃ²ng nháº­p ná»™i dung hoáº·c chá»n áº£nh Ä‘á»ƒ lÆ°u.", 'error');
             return;
        }

Â  Â  Â  Â  // 1. Kiá»ƒm tra náº¿u cÃ³ file má»›i
Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  showToast("â³ Äang táº£i áº£nh lÃªn Cloudinary, vui lÃ²ng chá»...", 'info');
Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  formData.append("file", file);
Â  Â  Â  Â  Â  formData.append("upload_preset", UPLOAD_PRESET);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  	 const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  Â  body: formData
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  uploadedUrl = data.secure_url;
              showToast("âœ… Táº£i áº£nh lÃªn thÃ nh cÃ´ng!", 'success');
Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  showToast("âŒ Lá»—i khi táº£i áº£nh lÃªn Cloudinary! áº¢nh sáº½ khÃ´ng Ä‘Æ°á»£c lÆ°u.", 'error');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. LÆ°u dá»¯ liá»‡u lÃªn Firestore
Â  Â  Â  Â  await setDoc(doc(db, "data", "timetable"), { 
Â  Â  Â  Â  Â  content,
Â  Â  Â  Â  Â  // Æ¯u tiÃªn áº£nh má»›i, náº¿u khÃ´ng cÃ³ thÃ¬ giá»¯ áº£nh cÅ© (náº¿u cÃ³)
Â  Â  Â  Â  Â  image: uploadedUrl || (tkbData ? tkbData.image : null),
Â  Â  Â  Â  Â  updatedAt: new Date()
Â  Â  Â  Â  });
Â  Â  Â  Â  showToast("ğŸ’¾ LÆ°u Thá»i KhÃ³a Biá»ƒu thÃ nh cÃ´ng!", 'success');
Â  Â  Â  Â  loadTimetable();
Â  Â  Â  Â  // Cáº­p nháº­t láº¡i cache sau khi lÆ°u thÃ nh cÃ´ng
Â  Â  Â  Â  tkbData = { content, image: uploadedUrl || (tkbData ? tkbData.image : null) };
Â  Â  Â  Â  uploadedUrl = null; // Reset biáº¿n upload
Â  Â  Â  };

Â  Â  Â  // NÃºt xÃ³a dá»¯ liá»‡u
Â  Â  Â  document.getElementById("delete-btn").onclick = async () => {
Â  Â  Â  Â  Â  // Giá»¯ confirm vÃ¬ Ä‘Ã¢y lÃ  thao tÃ¡c quan trá»ng, cáº§n cháº·n ngÆ°á»i dÃ¹ng
Â  Â  Â  Â  Â  if (confirm("âš ï¸ Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n XÃ“A toÃ n bá»™ dá»¯ liá»‡u thá»i khÃ³a biá»ƒu? Thao tÃ¡c nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.")) { 
Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(db, "data", "timetable"), { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  content: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  image: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  updatedAt: new Date()
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  document.getElementById("tkb").value = "";
Â  Â  Â  Â  Â  Â  Â  document.getElementById("preview").style.display = "none";
Â  Â  Â  Â  Â  Â  Â  document.getElementById("preview").src = "";
Â  Â  Â  Â  Â  Â  Â  fileInput.value = "";
Â  Â  Â  Â  Â  Â  Â  tkbData = {}; // Reset cache
Â  Â  Â  Â  Â  Â  Â  showToast("ğŸ—‘ï¸ ÄÃ£ xÃ³a dá»¯ liá»‡u thá»i khÃ³a biá»ƒu!", 'success');
Â  Â  Â  Â  Â  Â  Â  loadTimetable();
Â  Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  });
Â  </script>
</body>
</html>