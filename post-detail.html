<!DOCTYPE html>
<html lang="vi">
<head>
Â  <meta charset="UTF-8">
Â  <title>Chi tiáº¿t bÃ i viáº¿t</title>
Â  <link rel="stylesheet" href="style.css">
Â  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
Â  <style>
    /* CSS cho cÃ¡c thÃ nh pháº§n bÃ i viáº¿t (cÃ³ thá»ƒ náº±m trong style.css) */
    .post-image {
        width: 100%;
        max-height: 400px; 
        object-fit: contain;
        border-radius: 10px;
        margin: 15px 0;
        border: 1px solid #eee;
    }
    .post-body {
        white-space: pre-line;
        line-height: 1.7;
        font-size: 1.05rem;
        margin-bottom: 25px;
    }
    
    /* ===== NÃšT LIKE (ÄÃƒ DI CHUYá»‚N) ===== */
    #likeSection {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 15px 0 30px 0; /* TÄƒng khoáº£ng cÃ¡ch dÆ°á»›i nÃºt Like */
        padding-top: 10px;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee; /* ThÃªm Ä‘Æ°á»ng káº» dÆ°á»›i Like Ä‘á»ƒ phÃ¢n tÃ¡ch */
        padding-bottom: 10px;
    }

    #likeBtn {
        background: #e74c3c; 
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    #likeBtn.liked {
        background: #2ecc71; 
    }

    #likeBtn:hover {
        opacity: 0.85;
    }
    
    /* ===== COMMENT SECTION (VOTE) ===== */
    .comments {
      margin-top: 30px;
      text-align: left;
    }

    .comment {
      background: #f8f9fa;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid #1abc9c;
      display: flex; /* DÃ¹ng flex Ä‘á»ƒ xáº¿p Vote Box vÃ  Comment content */
      gap: 15px;
    }

    .comment-content {
        flex-grow: 1;
    }

    .comment small {
      color: #666;
      display: block;
      margin-bottom: 4px;
    }

    /* Khung Vote */
    .vote-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 1rem;
        color: #777;
        min-width: 30px; /* Äáº£m báº£o Ä‘á»§ chá»— cho nÃºt */
    }

    .vote-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.3rem;
        color: #bdc3c7;
        transition: color 0.2s;
        padding: 0 5px;
        line-height: 1;
    }
    
    .vote-btn:hover {
        color: #3498db;
    }
    
    /* Tráº¡ng thÃ¡i Ä‘Ã£ vote */
    .vote-btn.upvoted {
        color: #2ecc71; /* Xanh lÃ¡ cho Upvote */
    }

    .vote-btn.downvoted {
        color: #e74c3c; /* Äá» cho Downvote */
    }

    .login-warning {
        background: #fef0f0;
        color: #e74c3c;
        padding: 15px;
        border-radius: 8px;
        border: 1px dashed #e74c3c;
        text-align: center;
        margin-top: 20px;
    }
  </style>
</head>
<body>
Â  <div id="navbar"></div>

Â  <script type="module">
Â  Â  fetch("nav.html")
Â  Â  Â  .then(res => res.text())
Â  Â  Â  .then(html => {
Â  Â  Â  Â  document.getElementById("navbar").innerHTML = html;
Â  Â  Â  Â  import('./nav.js');
Â  Â  Â  });
Â  </script>

Â  <div id="toast-container" class="toast-container"></div> 

Â  <div class="container-detail">
Â  Â  <a href="forum.html" class="back-btn">â¬…ï¸ Quay láº¡i diá»…n Ä‘Ã n</a>
Â  Â  <h1 id="postTitle">Äang táº£i...</h1>
Â  Â  <p class="meta" id="postMeta"></p>
Â  Â  <img id="postImage" class="post-image" style="display:none;">
Â  Â  <p id="postBody" class="post-body"></p>
    
    <div id="likeSection"></div> 
Â  Â  
Â  Â  <div class="comments">
Â  Â  Â  <h2>ğŸ’¬ BÃ¬nh luáº­n (<span id="commentCount">0</span>)</h2>
Â  Â  Â  <div id="commentSection"></div> Â  Â  Â  <div id="commentList"></div> </div>
Â  </div>

Â  <script type="module">
Â  Â  import { auth, db } from './firebase.js';
Â  Â  import { doc, getDoc, collection, getDocs, orderBy, query, addDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
Â  Â  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

Â  Â  // ğŸ’¡ HÃ€M HIá»‚N THá»Š TOAST Má»šI ğŸ’¡
Â  Â  function showToast(message, type = 'success') {
Â  Â  Â  Â  const container = document.getElementById('toast-container');
Â  Â  Â  Â  const toast = document.createElement('div');
Â  Â  Â  Â  toast.className = `toast ${type}`;
Â  Â  Â  Â  
Â  Â  Â  Â  let icon = '';
Â  Â  Â  Â  if (type === 'success') {
Â  Â  Â  Â  Â  Â  icon = 'âœ…';
Â  Â  Â  Â  } else if (type === 'error') {
Â  Â  Â  Â  Â  Â  icon = 'âŒ';
Â  Â  Â  Â  Â  Â  toast.style.borderLeftColor = '#e74c3c'; 
Â  Â  Â  Â  } else if (type === 'info') {
            icon = 'â„¹ï¸';
            toast.style.borderLeftColor = '#3498db'; 
        }
Â  Â  Â  Â  
Â  Â  Â  Â  toast.innerHTML = `<span>${icon}</span> ${message}`;
Â  Â  Â  Â  container.appendChild(toast);

Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  toast.classList.add('show');
Â  Â  Â  Â  }, 10); 

Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  toast.classList.remove('show');
Â  Â  Â  Â  Â  Â  toast.addEventListener('transitionend', () => {
Â  Â  Â  Â  Â  Â  Â  Â  toast.remove();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }, 3000);
Â  Â  }
Â  Â  // ğŸ’¡ Káº¾T THÃšC HÃ€M TOAST ğŸ’¡

Â  Â  // ğŸ” Láº¥y ID bÃ i viáº¿t tá»« URL
Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  const postId = params.get("id");

Â  Â  // Biáº¿n DOM
Â  Â  const titleEl = document.getElementById("postTitle");
Â  Â  const metaEl = document.getElementById("postMeta");
Â  Â  const bodyEl = document.getElementById("postBody");
Â  Â  const imgEl = document.getElementById("postImage");
Â  Â  const commentList = document.getElementById("commentList");
Â  Â  const commentCountEl = document.getElementById("commentCount");
Â  Â  const commentSection = document.getElementById("commentSection");
    const likeSection = document.getElementById("likeSection");
    
    // Biáº¿n toÃ n cá»¥c Ä‘á»ƒ lÆ°u dá»¯ liá»‡u bÃ i viáº¿t
    let currentPostData = null;
    let currentUser = null; // Biáº¿n lÆ°u user Ä‘Ã£ Ä‘Äƒng nháº­p

    // ğŸ”¥ HÃ€M Xá»¬ LÃ LIKE BÃ€I VIáº¾T
    async function toggleLike(user) {
        if (!user || !currentPostData) return;
        
        const postRef = doc(db, "posts", postId);
        const userId = user.uid;
        const isLiked = Array.isArray(currentPostData.likes) && currentPostData.likes.includes(userId);

        try {
            if (isLiked) {
                await updateDoc(postRef, {
                    likes: arrayRemove(userId)
                });
                showToast("ÄÃ£ há»§y thÃ­ch bÃ i viáº¿t.", 'info');
            } else {
                await updateDoc(postRef, {
                    likes: arrayUnion(userId)
                });
                showToast("ÄÃ£ thÃ­ch bÃ i viáº¿t! â¤ï¸", 'success');
            }
            loadPostDetail(user); 
        } catch(e) {
            showToast("Lá»—i khi xá»­ lÃ½ Like: " + e.message, 'error');
        }
    }

    // ğŸ”¥ HÃ€M Xá»¬ LÃ VOTE BÃŒNH LUáº¬N
    async function toggleCommentVote(commentId, type) {
        if (!currentUser) {
            showToast("Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ vote bÃ¬nh luáº­n!", 'error');
            return;
        }

        const commentRef = doc(db, "posts", postId, "comments", commentId);
        const userId = currentUser.uid;
        
        // 1. Láº¥y dá»¯ liá»‡u bÃ¬nh luáº­n hiá»‡n táº¡i
        const snap = await getDoc(commentRef);
        if (!snap.exists()) return;
        const c = snap.data();

        let upvotes = Array.isArray(c.upvotes) ? c.upvotes : [];
        let downvotes = Array.isArray(c.downvotes) ? c.downvotes : [];

        // Kiá»ƒm tra tráº¡ng thÃ¡i hiá»‡n táº¡i
        const isUpvoted = upvotes.includes(userId);
        const isDownvoted = downvotes.includes(userId);
        
        let updateData = {};

        try {
            if (type === 'up') {
                if (isUpvoted) {
                    // Há»§y upvote
                    updateData.upvotes = arrayRemove(userId);
                    showToast("ÄÃ£ há»§y Upvote.", 'info');
                } else {
                    // Upvote: thÃªm Upvote, xÃ³a Downvote (náº¿u cÃ³)
                    updateData.upvotes = arrayUnion(userId);
                    if (isDownvoted) {
                        updateData.downvotes = arrayRemove(userId);
                    }
                    showToast("ÄÃ£ Upvote bÃ¬nh luáº­n! ğŸ‘", 'success');
                }
            } else if (type === 'down') {
                if (isDownvoted) {
                    // Há»§y downvote
                    updateData.downvotes = arrayRemove(userId);
                    showToast("ÄÃ£ há»§y Downvote.", 'info');
                } else {
                    // Downvote: thÃªm Downvote, xÃ³a Upvote (náº¿u cÃ³)
                    updateData.downvotes = arrayUnion(userId);
                    if (isUpvoted) {
                        updateData.upvotes = arrayRemove(userId);
                    }
                    showToast("ÄÃ£ Downvote bÃ¬nh luáº­n! ğŸ‘", 'info');
                }
            }

            if (Object.keys(updateData).length > 0) {
                await updateDoc(commentRef, updateData);
                // Cáº­p nháº­t giao diá»‡n sau khi vote
                loadComments(); 
            }
        } catch(e) {
            showToast("Lá»—i khi xá»­ lÃ½ Vote: " + e.message, 'error');
        }
    }

Â  Â  // ğŸ”¥ Load chi tiáº¿t bÃ i viáº¿t (Cho pháº§n Like)
Â  Â  async function loadPostDetail(user = null) {
Â  Â  Â  const ref = doc(db, "posts", postId);
Â  Â  Â  const snap = await getDoc(ref);
Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  titleEl.textContent = "BÃ i viáº¿t khÃ´ng tá»“n táº¡i ğŸ˜¢";
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const data = snap.data();
      currentPostData = data; 
Â  Â  Â  const time = data.createdAt ? data.createdAt.toDate().toLocaleString() : "Vá»«a Ä‘Äƒng";
      
      const likes = Array.isArray(data.likes) ? data.likes.length : 0;
      const isLiked = user && Array.isArray(data.likes) && data.likes.includes(user.uid);

Â  Â  Â  titleEl.textContent = data.title;
Â  Â  Â  bodyEl.textContent = data.body;
Â  Â  Â  metaEl.innerHTML = `âœï¸ TÃ¡c giáº£: <b>${data.username || "áº¨n danh"}</b> â€¢ ğŸ•“ ${time}`;
Â  Â  Â  
Â  Â  Â  if (data.imageUrl) {
Â  Â  Â  Â  imgEl.src = data.imageUrl;
Â  Â  Â  Â  imgEl.style.display = "block";
Â  Â  Â  } else {
        imgEl.style.display = "none";
      }
        
    // ğŸ”¥ HIá»‚N THá»Š NÃšT LIKE
    let likeHtml = `
        <span style="font-size:1.1rem;color:#777;">ğŸ‘ ${likes} ThÃ­ch</span>
    `;

    if (user) {
        const btnClass = isLiked ? 'liked' : '';
        const btnText = isLiked ? 'ğŸ’š ÄÃ£ thÃ­ch' : 'â¤ï¸ ThÃ­ch';
        likeHtml = `
            <button id="likeBtn" class="${btnClass}">${btnText}</button>
            <span style="font-size:1.1rem;color:#777;">ğŸ‘ ${likes} ThÃ­ch</span>
        `;
    } 
    likeSection.innerHTML = likeHtml;

    // Gáº¯n sá»± kiá»‡n cho nÃºt Like
    if (user) {
        document.getElementById("likeBtn").onclick = () => toggleLike(user);
    }
Â  Â  }

Â  Â  // ğŸ”¥ Load bÃ¬nh luáº­n (ÄÃƒ Cáº¬P NHáº¬T Ä‘á»ƒ hiá»ƒn thá»‹ Vote)
Â  Â  async function loadComments() {
Â  Â  Â  const col = collection(db, "posts", postId, "comments");
Â  Â  Â  // Sáº¯p xáº¿p bÃ¬nh luáº­n theo thá»i gian táº¡o, má»›i nháº¥t lÃªn Ä‘áº§u
Â  Â  Â  const q = query(col, orderBy("createdAt", "desc")); 
Â  Â  Â  const snap = await getDocs(q);
Â  Â  Â  
Â  Â  Â  commentCountEl.textContent = snap.size;
Â  Â  Â  commentList.innerHTML = "";

Â  Â  Â  snap.forEach(docSnap => {
Â  Â  Â  Â  const c = docSnap.data();
        const commentId = docSnap.id;
Â  Â  Â  Â  const time = c.createdAt && c.createdAt.toDate ? c.createdAt.toDate().toLocaleString() : "Vá»«a Ä‘Äƒng";
        
        // TÃ­nh toÃ¡n Vote
        const upvotes = Array.isArray(c.upvotes) ? c.upvotes.length : 0;
        const downvotes = Array.isArray(c.downvotes) ? c.downvotes.length : 0;
        const totalVotes = upvotes - downvotes;
        
        // Kiá»ƒm tra tráº¡ng thÃ¡i Vote cá»§a ngÆ°á»i dÃ¹ng hiá»‡n táº¡i
        const userId = currentUser ? currentUser.uid : null;
        const isUpvoted = userId && Array.isArray(c.upvotes) && c.upvotes.includes(userId);
        const isDownvoted = userId && Array.isArray(c.downvotes) && c.downvotes.includes(userId);
        
        // CSS cho nÃºt Vote
        const upvoteClass = isUpvoted ? 'upvoted' : '';
        const downvoteClass = isDownvoted ? 'downvoted' : '';

        // Táº¡o Vote Box HTML
        let voteBoxHtml = `
            <div class="vote-box">
                <button class="vote-btn up-btn ${upvoteClass}" data-id="${commentId}" data-type="up">â–²</button>
                <span class="vote-count" style="font-weight:600; color:${totalVotes >= 0 ? '#2ecc71' : '#e74c3c'}">${totalVotes}</span>
                <button class="vote-btn down-btn ${downvoteClass}" data-id="${commentId}" data-type="down">â–¼</button>
            </div>
        `;
        
Â  Â  Â  Â  commentList.innerHTML += `
Â  Â  Â  Â  Â  <div class="comment">
              ${voteBoxHtml}
              <div class="comment-content">
Â  Â  Â  Â  Â  Â        <small>ğŸ‘¤ ${c.username || "áº¨n danh"} â€¢ ${time}</small>
Â  Â  Â  Â  Â  Â        <p>${c.text}</p>
              </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  });
      
      // Gáº¯n sá»± kiá»‡n Vote sau khi DOM Ä‘Æ°á»£c táº¡o
      document.querySelectorAll('.vote-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
              const id = e.currentTarget.dataset.id;
              const type = e.currentTarget.dataset.type;
              toggleCommentVote(id, type);
          });
      });
Â  Â  }

Â  Â  // Láº¯ng nghe tráº¡ng thÃ¡i Ä‘Äƒng nháº­p
Â  Â  onAuthStateChanged(auth, user => {
        currentUser = user; // LÆ°u user hiá»‡n táº¡i
        
        // Gá»i loadPostDetail Ä‘á»ƒ xá»­ lÃ½ tráº¡ng thÃ¡i Like cá»§a user
        loadPostDetail(user); 
        // Gá»i loadComments Ä‘á»ƒ xá»­ lÃ½ tráº¡ng thÃ¡i Vote cá»§a user
        loadComments();

Â  Â  Â  if (user) {
Â  Â  Â  Â  commentSection.innerHTML = `
Â  Â  Â  Â  Â  <form id="commentForm">
Â  Â  Â  Â  Â  Â  <textarea id="commentText" placeholder="Viáº¿t bÃ¬nh luáº­n cá»§a báº¡n..."></textarea>
Â  Â  Â  Â  Â  Â  <button type="submit" class="comment-btn">Gá»­i bÃ¬nh luáº­n</button>
Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  `;

Â  Â  Â  Â  const form = document.getElementById("commentForm");
Â  Â  Â  Â  form.addEventListener("submit", async e => {
Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  const text = document.getElementById("commentText").value.trim();
Â  Â  Â  Â  Â  if (!text) {
Â  Â  Â  Â  Â  Â  Â showToast("Báº¡n chÆ°a nháº­p ná»™i dung bÃ¬nh luáº­n!", 'error'); 
Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â await addDoc(collection(db, "posts", postId, "comments"), {
Â  Â  Â  Â  Â  Â  Â  Â  text,
Â  Â  Â  Â  Â  Â  Â  Â  username: user.displayName || user.email.split("@")[0],
Â  Â  Â  Â  Â  Â  Â  Â  createdAt: serverTimestamp(),
                // Khá»Ÿi táº¡o máº£ng vote rá»—ng
                upvotes: [],
                downvotes: []
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â form.reset();
Â  Â  Â  Â  Â  Â  Â await loadComments();
Â  Â  Â  Â  Â  Â  Â showToast("Gá»­i bÃ¬nh luáº­n thÃ nh cÃ´ng!", 'success'); 
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â showToast("Lá»—i khi gá»­i bÃ¬nh luáº­n: " + e.message, 'error');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  commentSection.innerHTML = `
Â  Â  Â  Â  Â  <div class="login-warning">
Â  Â  Â  Â  Â  Â  âš ï¸ Báº¡n cáº§n <a href="login.html" style="color:#3498db;text-decoration:underline;">ÄÄƒng nháº­p</a> Ä‘á»ƒ bÃ¬nh luáº­n vÃ  vote!
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  }
Â  Â  });
</script>
</body>
</html>