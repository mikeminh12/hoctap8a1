<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Diễn đàn học tập</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="navbar"></div>

  <script type="module">
    // 🔥 Load nav.html trước, rồi mới load nav.js
    fetch("nav.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("navbar").innerHTML = html;
        import('./nav.js');
      });
  </script>

  <div class="container fade-in">
    <h1>📚 Diễn đàn học tập</h1>
    <p style="margin-bottom: 20px;">Chia sẻ kiến thức, thảo luận bài tập, hỏi đáp học tập tại đây!</p>

    <button id="postBtn">📝 Đăng bài</button>
    <hr> <div id="posts">⏳ Đang tải bài viết...</div>
  </div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { collection, getDocs, orderBy, query } 
      from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // 🟢 Hiện nút Đăng bài nếu user đã đăng nhập
    onAuthStateChanged(auth, user => {
      if (user) {
        const btn = document.getElementById("postBtn");
        btn.style.display = "inline-block";
        btn.onclick = () => location.href = "post.html";
      }
    });

    // 📰 Load bài viết
    try {
      const postCol = collection(db, "posts");
      const q = query(postCol, orderBy("createdAt", "desc"));
      const snap = await getDocs(q);
      const container = document.getElementById("posts");

      if (snap.empty) {
        container.innerHTML = "<p>😶 Chưa có bài viết nào, hãy là người đầu tiên đăng nhé!</p>";
      } else {
        container.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          container.innerHTML += `
            <div class="card">
              <h3>${d.title}</h3>
              <small>✍️ Tác giả: <b>${d.username || "Ẩn danh"}</b></small><br>
              <button class="btn-card" onclick="window.location.href='post-detail.html?id=${docSnap.id}'">
                Xem chi tiết
              </button>
            </div>
          `;
        });
      }

    } catch(err) {
      document.getElementById("posts").innerHTML = "<p>❌ Lỗi khi tải dữ liệu: " + err.message + "</p>";
    }
  </script>
</body>
</html>