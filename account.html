<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ThÃ´ng tin tÃ i khoáº£n</title>
  <link id="theme-style" rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<script src="snow.js"></script>
<body>

  <div id="navbar"></div>

  <script type="module">
    // Load nav.html trÆ°á»›c, rá»“i má»›i load nav.js
    fetch("nav.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("navbar").innerHTML = html;
        import('./nav.js');
      });
  </script>

  <div id="toast-container" class="toast-container"></div>

  <div class="container login-container">
    <h2>ğŸ‘¤ ThÃ´ng tin tÃ i khoáº£n</h2>

    <div id="user-info" class="hidden">
      
      <div class="avatar-upload-section">
        <img id="currentAvatar" src="non.png" alt="áº¢nh Ä‘áº¡i diá»‡n" class="current-avatar">
        <div>
          <label for="avatarInput">Chá»n áº£nh Ä‘áº¡i diá»‡n má»›i</label>
          <input type="file" id="avatarInput" accept="image/*">
          <button id="uploadAvatarBtn" class="btn-login" style="margin-top: 10px;">â¬†ï¸ Táº£i lÃªn</button>
          <span id="avatarUploadStatus" class="upload-status"></span>
        </div>
      </div>
      <hr>

      <p><b>TÃ i khoáº£n:</b> <span id="username"></span></p>
      <p><b>Vai trÃ²:</b> <span id="role"></span></p>
      <p><b>Tráº¡ng thÃ¡i:</b> <span id="status" class="status"></span></p>

      <label>TÃªn tháº­t</label>
      <input id="realName" placeholder="Nháº­p tÃªn tháº­t...">

      <label>Sá»‘ Ä‘iá»‡n thoáº¡i</label>
      <input id="phone" placeholder="Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i...">

      <div class="login-actions">
        <button id="save" class="btn-login">ğŸ’¾ LÆ°u thay Ä‘á»•i</button>
        <button id="request" class="btn-signup">ğŸ“© Gá»­i yÃªu cáº§u kÃ­ch hoáº¡t</button>
      </div>

      <button id="logout" style="background:#dc3545; margin-top:14px;">ğŸšª ÄÄƒng xuáº¥t</button>
    </div>

    <div id="not-logged">
      <p>âš ï¸ Báº¡n chÆ°a Ä‘Äƒng nháº­p. <a href="login.html">ÄÄƒng nháº­p ngay</a>.</p>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // Cáº¥u hÃ¬nh Cloudinary (Láº¥y tá»« doc.html)
    const CLOUD_NAME = "dmxz0m1x3";
    const UPLOAD_PRESET = "8a1_upload";
    const DEFAULT_AVATAR_PATH = 'non.png';

    // ğŸ§ƒ Toast function 
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        let icon = type === 'success' ? 'âœ…' : 'âŒ';
        toast.innerHTML = `<span>${icon}</span> ${message}`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }

    // Element refs
    const usernameEl = document.getElementById("username");
    const roleEl = document.getElementById("role");
    const statusEl = document.getElementById("status");
    const realNameEl = document.getElementById("realName");
    const phoneEl = document.getElementById("phone");
    const saveBtn = document.getElementById("save");
    const requestBtn = document.getElementById("request");
    const logoutBtn = document.getElementById("logout");
    const userInfo = document.getElementById("user-info");
    const notLogged = document.getElementById("not-logged");

    // Refs má»›i cho Avatar
    const currentAvatarEl = document.getElementById("currentAvatar");
    const avatarInput = document.getElementById("avatarInput");
    const uploadAvatarBtn = document.getElementById("uploadAvatarBtn");
    const avatarUploadStatusEl = document.getElementById("avatarUploadStatus");


    // ğŸ§  Load data khi Ä‘Ã£ Ä‘Äƒng nháº­p
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        userInfo.classList.add("hidden");
        notLogged.classList.remove("hidden");
        return;
      }

      notLogged.classList.add("hidden");
      userInfo.classList.remove("hidden");

      const uid = user.uid;
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      const data = snap.data();

      if (!snap.exists() || !data) {
        showToast("KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin tÃ i khoáº£n!", "error");
        return;
      }

      // Cáº­p nháº­t Avatar hiá»‡n táº¡i
      currentAvatarEl.src = user.photoURL || DEFAULT_AVATAR_PATH;
      
      usernameEl.textContent = data.username || "(chÆ°a cÃ³)";
      roleEl.textContent = data.role === 'admin' ? "Quáº£n trá»‹ viÃªn ğŸ‘‘" : "Há»c sinh";
      realNameEl.value = data.realName || "";
      phoneEl.value = data.phone || "";

      // Sá»¬A LOGIC TRáº NG THÃI KÃCH HOáº T
      if (data.isBanned) {
        statusEl.textContent = "âŒ ÄÃ£ bá»‹ cáº¥m (Bá»‹ khÃ³a)";
        statusEl.style.color = "#dc3545"; // Äá»
      } else if (data.isActive) {
        statusEl.textContent = "âœ… ÄÃ£ kÃ­ch hoáº¡t";
        statusEl.style.color = "green";
      } else if (data.activationRequested) {
        statusEl.textContent = "â³ ÄÃ£ gá»­i yÃªu cáº§u kÃ­ch hoáº¡t";
        statusEl.style.color = "orange";
      } else {
        statusEl.textContent = "ğŸš« ChÆ°a kÃ­ch hoáº¡t";
        statusEl.style.color = "red";
      }

      // 1. Cáº­p nháº­t info
      saveBtn.onclick = async () => {
        try {
          await updateDoc(ref, {
            realName: realNameEl.value.trim(),
            phone: phoneEl.value.trim()
          });
          showToast("ÄÃ£ lÆ°u thÃ´ng tin!");
        } catch (err) {
          showToast("Lá»—i khi lÆ°u: " + err.message, "error");
        }
      };

      // 2. Gá»­i yÃªu cáº§u kÃ­ch hoáº¡t
      requestBtn.onclick = async () => {
        if (data.isActive || data.isBanned) return;
        try {
          await updateDoc(ref, {
            activationRequested: true,
            requestedAt: Date.now()
          });
          showToast("ÄÃ£ gá»­i yÃªu cáº§u kÃ­ch hoáº¡t!");
          // Cáº­p nháº­t tráº¡ng thÃ¡i hiá»ƒn thá»‹
          statusEl.textContent = "â³ ÄÃ£ gá»­i yÃªu cáº§u kÃ­ch hoáº¡t";
          statusEl.style.color = "orange";
        } catch (err) {
          showToast("Lá»—i khi gá»­i yÃªu cáº§u: " + err.message, "error");
        }
      };

      // 3. Xá»­ lÃ½ Upload Avatar
      uploadAvatarBtn.onclick = async () => {
        const file = avatarInput.files[0];
        if (!file) return showToast("Vui lÃ²ng chá»n áº£nh Ä‘á»ƒ táº£i lÃªn!", "error");
        if (!file.type.startsWith('image/')) return showToast("Chá»‰ cháº¥p nháº­n file áº£nh!", "error");

        avatarUploadStatusEl.textContent = "â˜ï¸ Äang táº£i lÃªn Cloudinary...";
        avatarUploadStatusEl.style.color = "#555";
        uploadAvatarBtn.disabled = true;

        try {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("upload_preset", UPLOAD_PRESET);

          // Gá»­i file lÃªn Cloudinary
          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
            method: "POST",
            body: formData
          });

          const data = await res.json();
          if (!data.secure_url) throw new Error("Upload tháº¥t báº¡i!");

          // 1. Cáº­p nháº­t Firebase Auth (photoURL)
          await updateProfile(user, { photoURL: data.secure_url });

          // 2. Cáº­p nháº­t giao diá»‡n
          currentAvatarEl.src = data.secure_url;
          showToast("ÄÃ£ cáº­p nháº­t áº£nh Ä‘áº¡i diá»‡n thÃ nh cÃ´ng! âœ…");
          
          avatarUploadStatusEl.textContent = "âœ… Táº£i lÃªn thÃ nh cÃ´ng!";
          avatarUploadStatusEl.style.color = "green";

        } catch (err) {
          console.error(err);
          avatarUploadStatusEl.textContent = "âŒ Lá»—i táº£i lÃªn Avatar!";
          avatarUploadStatusEl.style.color = "red";
          showToast("KhÃ´ng thá»ƒ táº£i lÃªn áº£nh Ä‘áº¡i diá»‡n!", "error");
        } finally {
          uploadAvatarBtn.disabled = false;
          avatarInput.value = ""; // Reset input file
          setTimeout(() => avatarUploadStatusEl.textContent = "", 4000);
        }
      };

      // 4. ÄÄƒng xuáº¥t
      logoutBtn.onclick = async () => {
        await signOut(auth);
        localStorage.removeItem("user");
        showToast("ÄÃ£ Ä‘Äƒng xuáº¥t!");
        setTimeout(() => location.href = "login.html", 1500);
      };
    });
  </script>

</body>
</html>