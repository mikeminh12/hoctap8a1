<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Editor PhÃ¡o Hoa - 15 PhÃºt</title>
    <style>
        body { display: flex; height: 100vh; margin: 0; background: #111; color: white; font-family: sans-serif; }
        #panel { width: 350px; padding: 20px; background: #222; overflow-y: auto; border-right: 2px solid #444; }
        #stage-picker { width: 100%; height: 200px; background: #000; position: relative; border: 1px solid #555; cursor: crosshair; }
        #marker { position: absolute; width: 10px; height: 10px; background: red; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .section { background: #333; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        input, select, button { width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: none; }
        button { cursor: pointer; font-weight: bold; }
        .btn-save { background: #4CAF50; color: white; }
        .btn-load { background: #2196F3; color: white; }
        .item { padding: 5px; border-bottom: 1px solid #555; font-size: 12px; position: relative; }
        .del { position: absolute; right: 5px; top: 5px; color: red; cursor: pointer; }
        #preview { flex: 1; background: #000; position: relative; }
    </style>
</head>
<body>

<div id="panel">
    <h3>ğŸ† BiÃªn Äáº¡o Show</h3>
    <button class="btn-load" onclick="window.loadFromFirebase()">ğŸ“‚ Táº£i tá»« Server</button>
    
    <div class="section">
        <label>Vá»‹ trÃ­ ná»• (Click khung dÆ°á»›i):</label>
        <div id="stage-picker"><div id="marker" style="left:50%; top:30%"></div></div>
        <input type="number" id="timeS" placeholder="GiÃ¢y báº¯t Ä‘áº§u" value="0" step="0.5">
        <select id="type">
            <option value="burst">ğŸ’¥ ChÃ¹m trÃ²n</option>
            <option value="sparkle">âœ¨ Láº¥p lÃ¡nh</option>
            <option value="flower">ğŸŒ¸ HÃ¬nh hoa</option>
            <option value="text">ğŸ”  Ná»• thÃ nh CHá»®</option>
        </select>
        <input type="text" id="textContent" placeholder="Ná»™i dung chá»¯" value="TET"> <input type="number" id="loopCount" value="1" min="1" placeholder="Sá»‘ láº§n láº·p">
        <input type="color" id="color" value="#ffff00">
        <button onclick="window.addClip()" style="background: orange;">â• ThÃªm quáº£ phÃ¡o</button>
    </div>

    <button onclick="window.previewShow()" style="background: #9c27b0; color: white;">â–¶ Cháº¡y thá»­ ká»‹ch báº£n</button>
    <button class="btn-save" onclick="window.uploadShow()">ğŸš€ LÆ°u lÃªn Firebase</button>
    
    <div id="list"></div>
</div>

<div id="preview"><canvas id="canvas"></canvas></div>

<script type="module">
    import { db, doc, setDoc, getDoc } from "./firebase.js";

    let timeline = [];
    let curX = 0.5, curY = 0.3;

    window.addClip = () => {
        timeline.push({
            s: parseFloat(document.getElementById('timeS').value),
            x: curX, y: curY,
            type: document.getElementById('type').value,
            color: document.getElementById('color').value,
            loopCount: parseInt(document.getElementById('loopCount').value) || 1
        });
        timeline.sort((a,b) => a.s - b.s);
        renderList();
    };

    window.removeClip = (i) => { timeline.splice(i, 1); renderList(); };

    window.previewShow = () => { if(window.runFireworkScript) window.runFireworkScript([...timeline]); };

    window.loadFromFirebase = async () => {
        const snap = await getDoc(doc(db, "events", "tet_firework"));
        if(snap.exists()) {
            timeline = snap.data().script || [];
            renderList();
            alert("Táº£i thÃ nh cÃ´ng!");
        }
    };

    window.uploadShow = async () => {
        try {
            await setDoc(doc(db, "events", "tet_firework"), { script: timeline, time: Date.now() + 5000 });
            alert("LÆ°u thÃ nh cÃ´ng!");
        } catch(e) { alert("Lá»—i: " + e.message); }
    };

    function renderList() {
        const listDiv = document.getElementById('list');
        listDiv.innerHTML = timeline.map((c, i) => `
            <div class="item">
                <b>${c.s}s</b>: ${c.type} (x${c.loopCount})
                <span class="del" onclick="window.removeClip(${i})">âœ–</span>
            </div>
        `).join('');
    }

    document.getElementById('stage-picker').onclick = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        curX = (e.clientX - rect.left) / rect.width;
        curY = (e.clientY - rect.top) / rect.height;
        document.getElementById('marker').style.left = (curX * 100) + "%";
        document.getElementById('marker').style.top = (curY * 100) + "%";
    };

    // Xuáº¥t ra window Ä‘á»ƒ Console cÃ³ thá»ƒ dÃ¹ng
    window.timeline = timeline;
    window.renderList = renderList;
</script>
<script src="firework.js"></script>
</body>
</html>