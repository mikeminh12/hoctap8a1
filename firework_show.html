<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Editor PhÃ¡o Hoa - Chá»‘ng Lá»—i Console</title>
    <style>
        body { display: flex; height: 100vh; margin: 0; background: #111; color: white; font-family: 'Segoe UI', sans-serif; }
        #panel { width: 380px; padding: 20px; background: #222; overflow-y: auto; border-right: 2px solid #444; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        #stage-picker { width: 100%; height: 220px; background: #000; position: relative; border: 2px solid #555; cursor: crosshair; margin-bottom: 10px; }
        #marker { position: absolute; width: 12px; height: 12px; background: #ff4757; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .section { background: #2f3542; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #444; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: none; box-sizing: border-box; }
        button { cursor: pointer; font-weight: 700; transition: 0.2s; }
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        .btn-save { background: #2ed573; color: white; }
        .btn-load { background: #1e90ff; color: white; margin-bottom: 10px; }
        .item { padding: 8px; border-bottom: 1px solid #444; font-size: 13px; position: relative; display: flex; justify-content: space-between; align-items: center; }
        .item:hover { background: #3e4451; }
        .del { color: #ff4757; cursor: pointer; padding: 5px; font-weight: bold; }
        #preview { flex: 1; background: #000; position: relative; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }
        h3 { margin-top: 0; color: #ffa502; border-bottom: 1px solid #444; padding-bottom: 10px; }
    </style>
</head>
<body>

<div id="panel">
    <a href="admin.html" style="text-decoration: none;"><button style="background: #57606f; color: white;">ğŸ  BACK TO ADMIN</button></a>
    <h3>ğŸ† BiÃªn Äáº¡o Show</h3>
    
    <button class="btn-load" id="btnLoad">ğŸ“‚ Táº£i ká»‹ch báº£n tá»« Server</button>
    
    <div class="section">
        <label style="font-size: 12px; color: #ced4da;">Vá»‹ trÃ­ ná»• (Click khung Ä‘en):</label>
        <div id="stage-picker"><div id="marker" style="left:50%; top:30%"></div></div>
        
        <input type="number" id="timeS" placeholder="GiÃ¢y báº¯t Ä‘áº§u" value="0" step="0.1">
        <select id="type">
            <option value="burst">ğŸ’¥ ChÃ¹m trÃ²n (Burst)</option>
            <option value="sparkle">âœ¨ Láº¥p lÃ¡nh (Sparkle)</option>
            <option value="flower">ğŸŒ¸ HÃ¬nh hoa (Flower)</option>
            <option value="text">ğŸ”  Ná»• thÃ nh CHá»® (Text)</option>
        </select>
        <input type="text" id="textContent" placeholder="Ná»™i dung chá»¯ (náº¿u chá»n Text)" value="HAPPY NEW YEAR">
        <input type="color" id="color" value="#ffeb3b">
        <button id="btnAdd" style="background: #ffa502; color: white;">â• ThÃªm quáº£ phÃ¡o</button>
    </div>

    <button id="btnPreview" style="background: #9c27b0; color: white;">â–¶ Cháº¡y thá»­ ká»‹ch báº£n</button>
    <button class="btn-save" id="btnSave">ğŸš€ LÆ°u lÃªn Firebase</button>
    
    <div id="list-container">
        <p style="font-size: 11px; color: #888;">Danh sÃ¡ch Timeline (<span id="count">0</span>):</p>
        <div id="list"></div>
    </div>
</div>

<div id="preview">
    <canvas id="canvas"></canvas>
</div>

<script>
    window.timeline = []; // Máº£ng chá»©a ká»‹ch báº£n (ToÃ n cá»¥c)

    // HÃ m render danh sÃ¡ch ra UI (ToÃ n cá»¥c)
    window.renderList = function() {
        const listDiv = document.getElementById('list');
        const countSpan = document.getElementById('count');
        if(!listDiv) return;

        // Sáº¯p xáº¿p theo thá»i gian
        window.timeline.sort((a, b) => a.s - b.s);
        
        countSpan.innerText = window.timeline.length;
        listDiv.innerHTML = window.timeline.map((c, i) => `
            <div class="item">
                <span><b>${c.s}s</b> - ${c.type.toUpperCase()} <span style="color:${c.color}">â—</span> ${c.text ? `'${c.text}'` : ''}</span>
                <span class="del" onclick="removeClip(${i})">âœ–</span>
            </div>
        `).join('');
    };

    window.removeClip = function(i) {
        window.timeline.splice(i, 1);
        window.renderList();
    };
</script>

<script type="module">
    import { db, doc, setDoc, getDoc, updateDoc } from "./firebase.js";

    let curX = 0.5, curY = 0.3;

    // --- Xá»¬ LÃ CLICK CHá»ŒN Vá»Š TRÃ ---
    document.getElementById('stage-picker').onclick = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        curX = (e.clientX - rect.left) / rect.width;
        curY = (e.clientY - rect.top) / rect.height;
        document.getElementById('marker').style.left = (curX * 100) + "%";
        document.getElementById('marker').style.top = (curY * 100) + "%";
    };

    // --- THÃŠM PHÃO THá»¦ CÃ”NG ---
    document.getElementById('btnAdd').onclick = () => {
        const type = document.getElementById('type').value;
        const newItem = {
            s: parseFloat(document.getElementById('timeS').value) || 0,
            x: parseFloat(curX.toFixed(3)),
            y: parseFloat(curY.toFixed(3)),
            type: type,
            color: document.getElementById('color').value,
            loopCount: 1
        };
        if(type === 'text') newItem.text = document.getElementById('textContent').value;

        window.timeline.push(newItem);
        window.renderList();
    };

    // --- CHáº Y THá»¬ ---
    document.getElementById('btnPreview').onclick = () => {
        if(window.runFireworkScript) {
            window.runFireworkScript([...window.timeline]);
        } else {
            alert("ChÆ°a náº¡p Ä‘Æ°á»£c firework.js!");
        }
    };

    // --- Táº¢I Tá»ª SERVER ---
    document.getElementById('btnLoad').onclick = async () => {
        const snap = await getDoc(doc(db, "events", "tet_firework"));
        if(snap.exists()) {
            window.timeline = snap.data().script || [];
            window.renderList();
            alert("ÄÃ£ táº£i ká»‹ch báº£n thÃ nh cÃ´ng!");
        }
    };

    // --- LÆ¯U LÃŠN SERVER ---
    document.getElementById('btnSave').onclick = async () => {
        try {
            await updateDoc(doc(db, "events", "tet_firework"), { 
                script: window.timeline 
            });
            alert("ğŸš€ ÄÃ£ lÆ°u ká»‹ch báº£n!");
        } catch(e) {
            await setDoc(doc(db, "events", "tet_firework"), { 
                script: window.timeline, enabled: true, time: Date.now() 
            }, {merge: true});
            alert("ğŸš€ ÄÃ£ táº¡o má»›i vÃ  lÆ°u ká»‹ch báº£n!");
        }
    };
</script>

<script src="firework.js"></script>
</body>
</html>