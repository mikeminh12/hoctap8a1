<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T√†i li·ªáu H·ªçc t·∫≠p</title>
  <link id="theme-style" rel="stylesheet" href="style.css">
</head>
<script src="snow.js"></script>
<body>
  <div id="navbar"></div>

  <script type="module">
    fetch("nav.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("navbar").innerHTML = html;
        import('./nav.js');
      });
  </script>

  <div class="container doc-main-container">
    <h1>üìö Qu·∫£n l√Ω & Xem T√†i li·ªáu</h1>
    
    <div id="adminView" class="doc-layout-admin" style="display: none;">
      <div class="folder-panel">
        <div id="adminControls">
          <h4>üõ†Ô∏è C√¥ng c·ª• Admin</h4>
          <div class="admin-section">
            <strong>+ Th√™m Th∆∞ m·ª•c m·ªõi</strong>
            <input type="text" id="newFolderName" placeholder="T√™n th∆∞ m·ª•c m·ªõi" class="input-full-width">
            <button id="addFolderBtn" class="btn-submit btn-full-width">T·∫°o Th∆∞ m·ª•c</button>
          </div>
          <hr>
          <div class="admin-section">
            <strong>‚¨ÜÔ∏è T·∫£i t·ªáp l√™n</strong>
            <input type="file" id="fileInput" accept="*" multiple class="input-file">
            <span id="uploadStatus" class="upload-status"></span>
            <button id="uploadFileBtn" class="btn-card btn-full-width">T·∫£i l√™n</button>
          </div>
        </div>
        <h3>üìÅ Th∆∞ m·ª•c Qu·∫£n l√Ω</h3>
        <div id="folders" class="folder-list">
          <p>ƒêang t·∫£i th∆∞ m·ª•c...</p>
        </div>
      </div>

      <div class="file-viewer-area">
        <h3>T√†i li·ªáu trong: <span id="currentFolderName">Vui l√≤ng ch·ªçn m·ªôt th∆∞ m·ª•c</span></h3>
        <div id="fileList" class="file-grid">
          <p class="file-placeholder">Ch·ªçn th∆∞ m·ª•c ƒë·ªÉ xem/qu·∫£n l√Ω t√†i li·ªáu.</p>
        </div>
      </div>
    </div>

    <div id="studentView" class="doc-layout-student" style="display: none;">
      <h3>üìÅ C√°c Kh√≥a h·ªçc & T√†i li·ªáu</h3>
      <div id="folderCardGrid" class="folder-grid">
        <p style="grid-column: 1 / -1; color:#777;">ƒêang t·∫£i danh s√°ch...</p>
      </div>
    </div>
  </div>

  <!-- MODAL xem t√†i li·ªáu (full screen, kh√¥ng c√≥ n√∫t t·∫£i) -->
  <div id="myModal" class="modal">
    <div class="modal-content" style="max-width:95%; height:95vh;">
      <span class="close-btn">&times;</span>
      <h3 id="modalTitle">T√™n T√†i li·ªáu</h3>
      <div id="modalBody" class="modal-body-viewer"></div>
    </div>
  </div>

  <!-- TOAST CONTAINER -->
  <div id="toast-container" class="toast-container"></div>

  <script type="module">
    import { 
      auth, db, onAuthStateChanged, signInAnonymously, signInWithCustomToken,
      doc, getDoc, setDoc, updateDoc, collection, onSnapshot, deleteDoc
    } from "./firebase.js";

    const CLOUD_NAME = "dmxz0m1x3";
    const UPLOAD_PRESET = "8a1_upload";

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let selectedFolderId = null;
    let allFolders = [];
    let isAdmin = false;

    const adminViewEl = document.getElementById('adminView');
    const studentViewEl = document.getElementById('studentView');
    const folderCardGridEl = document.getElementById('folderCardGrid');
    const foldersEl = document.getElementById('folders');
    const currentFolderNameEl = document.getElementById('currentFolderName');
    const fileListEl = document.getElementById('fileList');
    const newFolderNameInput = document.getElementById('newFolderName');
    const addFolderBtn = document.getElementById('addFolderBtn');
    const fileInput = document.getElementById('fileInput');
    const uploadFileBtn = document.getElementById('uploadFileBtn');
    const uploadStatusEl = document.getElementById('uploadStatus');

    const modal = document.getElementById("myModal");
    const closeBtn = document.querySelector(".close-btn");
    const modalTitleEl = document.getElementById("modalTitle");
    const modalBodyEl = document.getElementById("modalBody");

    // üí° TOAST M·ªöI
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      let icon = type === 'error' ? '‚ùå' : '‚úÖ';
      toast.innerHTML = `<span>${icon}</span> ${message}`;
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
      }, 3000);
    }

    // üî• Chuy·ªÉn view admin/student
    function switchView(is_Admin) {
      adminViewEl.style.display = is_Admin ? 'grid' : 'none';
      studentViewEl.style.display = is_Admin ? 'none' : 'block';
    }

    // üî• Firebase Auth
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        try {
          if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
          else await signInAnonymously(auth);
        } catch (error) {
          showToast("Kh√¥ng th·ªÉ x√°c th·ª±c ng∆∞·ªùi d√πng!", "error");
        }
      }
      let is_Admin_User = false;
      if (user) {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        is_Admin_User = userDoc.exists() && userDoc.data().role === 'admin';
      }
      isAdmin = is_Admin_User;
      switchView(isAdmin);
      if (allFolders.length > 0) renderAllContent(allFolders);
    });

    // üî• L·∫Øng nghe d·ªØ li·ªáu Firestore
    onSnapshot(collection(db, "docs"), (snapshot) => {
      const folders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      allFolders = folders;
      if (typeof isAdmin === 'boolean') renderAllContent(folders);
    }, () => showToast("L·ªói t·∫£i d·ªØ li·ªáu Firestore!", "error"));

    // Render to√†n b·ªô n·ªôi dung
    function renderAllContent(folders) {
      folders.sort((a, b) => a.name.localeCompare(b.name));
      if (isAdmin) {
        if (!selectedFolderId && folders.length > 0) selectedFolderId = folders[0].id;
        renderAdminFolders(folders);
        const activeFolder = folders.find(f => f.id === selectedFolderId);
        if (activeFolder) {
          currentFolderNameEl.textContent = `üìÇ ${activeFolder.name}`;
          renderFiles(activeFolder.files || []);
        } else {
          fileListEl.innerHTML = '<p class="file-placeholder">Ch·ªçn th∆∞ m·ª•c ƒë·ªÉ xem/qu·∫£n l√Ω t√†i li·ªáu.</p>';
        }
      } else renderStudentFolders(folders);
    }

    // üß© Render th∆∞ m·ª•c Admin
    function renderAdminFolders(folders) {
      foldersEl.innerHTML = '';
      folders.forEach(folder => {
        const item = document.createElement('div');
        const isActive = folder.id === selectedFolderId ? 'active' : '';
        item.className = `folder-item ${isActive}`;
        item.innerHTML = `
          <span>üìÅ ${folder.name}</span>
          <small>(${folder.files ? folder.files.length : 0})</small>
          ${isAdmin ? `<button class="delete-folder-btn" data-folder-id="${folder.id}">üóëÔ∏è</button>` : ''}
        `;
        item.onclick = (e) => {
          if (e.target.closest('.delete-folder-btn')) return;
          selectedFolderId = folder.id;
          currentFolderNameEl.textContent = `üìÇ ${folder.name}`;
          renderAdminFolders(folders);
          renderFiles(folder.files || []);
        };
        if (isAdmin) item.querySelector('.delete-folder-btn').onclick = () => handleDeleteFolder(folder.id, folder.name);
        foldersEl.appendChild(item);
      });
    }

    // üß© Render th∆∞ m·ª•c cho Student
    function renderStudentFolders(folders) {
      folderCardGridEl.innerHTML = folders.length
        ? folders.map(f => `
          <div class="folder-card" onclick="window.location.href='doc-detail.html?id=${f.id}'">
            <div class="icon">üìÇ</div>
            <h4>${f.name}</h4>
            <p>${f.files ? f.files.length : 0} t√†i li·ªáu</p>
          </div>
        `).join('')
        : '<p class="file-placeholder">Ch∆∞a c√≥ th∆∞ m·ª•c n√†o ƒë∆∞·ª£c t·∫°o.</p>';
    }

    // üß© Render file trong th∆∞ m·ª•c (Admin Panel)
    function renderFiles(files) {
      fileListEl.innerHTML = '';
      if (!files || files.length === 0) {
        fileListEl.innerHTML = '<p class="file-placeholder">Th∆∞ m·ª•c n√†y ch∆∞a c√≥ t√†i li·ªáu n√†o.</p>';
        return;
      }

      files.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

      files.forEach(file => {
        const card = document.createElement('div');
        card.className = 'file-card';
        const fileExt = file.name.split('.').pop().toUpperCase();

        let preview;
        if (file.type.startsWith('image/')) preview = `<img src="${file.url}" class="preview-img">`;
        else if (file.type.includes('pdf')) preview = `<div class="preview-img pdf">PDF</div>`;
        else preview = `<div class="preview-img other">${fileExt}</div>`;

        card.innerHTML = `
          ${preview}
          <h4>${file.name}</h4>
          <div class="file-actions">
            <button class="view-btn">üëÅÔ∏è</button>
            ${isAdmin ? `<button class="delete-btn">üóëÔ∏è</button>` : ''}
          </div>
        `;
        card.querySelector('.view-btn').onclick = () => showFileDetail(file);
        if (isAdmin) card.querySelector('.delete-btn').onclick = () => handleDeleteFile(file.url, file.name);
        fileListEl.appendChild(card);
      });
    }

    // üì§ Th√™m th∆∞ m·ª•c
    addFolderBtn.onclick = async () => {
      if (!isAdmin) return showToast("B·∫°n kh√¥ng c√≥ quy·ªÅn Admin!", "error");
      const folderName = newFolderNameInput.value.trim();
      if (!folderName) return showToast("Vui l√≤ng nh·∫≠p t√™n th∆∞ m·ª•c!", "error");
      const folderId = folderName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
      if (allFolders.find(f => f.id === folderId)) return showToast("T√™n th∆∞ m·ª•c ƒë√£ t·ªìn t·∫°i!", "error");

      try {
        await setDoc(doc(db, "docs", folderId), { name: folderName, files: [], createdAt: new Date() });
        newFolderNameInput.value = '';
        showToast(`T·∫°o th∆∞ m·ª•c "${folderName}" th√†nh c√¥ng üéâ`);
      } catch {
        showToast("Kh√¥ng th·ªÉ th√™m th∆∞ m·ª•c!", "error");
      }
    };

    // üóëÔ∏è X√≥a th∆∞ m·ª•c
    async function handleDeleteFolder(id, name) {
      if (!confirm(`X√≥a th∆∞ m·ª•c "${name}"?`)) return;
      try {
        await deleteDoc(doc(db, "docs", id));
        showToast(`ƒê√£ x√≥a "${name}" ‚úÖ`);
      } catch {
        showToast("L·ªói x√≥a th∆∞ m·ª•c!", "error");
      }
    }

    // üóëÔ∏è X√≥a file
    async function handleDeleteFile(fileUrl, fileName) {
      if (!confirm(`X√≥a t·ªáp "${fileName}"?`)) return;
      try {
        const folderDocRef = doc(db, "docs", selectedFolderId);
        const folderDoc = await getDoc(folderDocRef);
        if (folderDoc.exists()) {
          const updated = folderDoc.data().files.filter(f => f.url !== fileUrl);
          await updateDoc(folderDocRef, { files: updated });
          showToast(`ƒê√£ x√≥a "${fileName}" ‚úÖ`);
        }
      } catch {
        showToast("L·ªói x√≥a t·ªáp!", "error");
      }
    }
   // Upload file
uploadFileBtn.onclick = async () => {
  if (!isAdmin) return showToast("B·∫°n kh√¥ng c√≥ quy·ªÅn Admin!", "error");
  if (!selectedFolderId) return showToast("Vui l√≤ng ch·ªçn th∆∞ m·ª•c tr∆∞·ªõc!", "error");

  const files = Array.from(fileInput.files);
  if (files.length === 0) return showToast("Vui l√≤ng ch·ªçn t·ªáp!", "error");

  uploadStatusEl.textContent = `‚òÅÔ∏è ƒêang t·∫£i ${files.length} t·ªáp...`;
  uploadFileBtn.disabled = true;

  try {
    const folderRef = doc(db, "docs", selectedFolderId);
    const folderSnap = await getDoc(folderRef);
    const currentFiles = folderSnap.exists() ? folderSnap.data().files || [] : [];

    const uploadedFiles = [];

    for (const file of files) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);

      const res = await fetch(
        `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,
        { method: "POST", body: formData }
      );
      const data = await res.json();
      if (!data.secure_url) throw new Error("Upload fail");

      uploadedFiles.push({
        name: file.name,
        url: data.secure_url,
        type: file.type || "unknown",
        uploadedAt: new Date()
      });
    }

    await updateDoc(folderRef, {
      files: [...currentFiles, ...uploadedFiles]
    });

    fileInput.value = "";
    showToast(`ƒê√£ t·∫£i ${uploadedFiles.length} t·ªáp ‚úÖ`);
  } catch (e) {
    console.error(e);
    showToast("L·ªói t·∫£i file!", "error");
  } finally {
    uploadFileBtn.disabled = false;
    uploadStatusEl.textContent = "";
  }
};



    // üëÅÔ∏è Modal xem tr∆∞·ªõc
    function showFileDetail(file) {
      modalTitleEl.textContent = file.name;
      modalBodyEl.innerHTML = '';
      const iframeHeight = 'calc(100vh - 200px)';
      if (file.type.startsWith('image/'))
        modalBodyEl.innerHTML = `<img src="${file.url}" style="max-width:100%; display:block; margin:auto;">`;
      else if (file.type.includes('pdf'))
        modalBodyEl.innerHTML = `<iframe src="${file.url}" width="100%" height="${iframeHeight}" frameborder="0"></iframe>`;
      else if (file.url.match(/\.(docx|pptx|xlsx)$/i))
        modalBodyEl.innerHTML = `<iframe src="https://docs.google.com/viewer?url=${encodeURIComponent(file.url)}&embedded=true" width="100%" height="${iframeHeight}" frameborder="0"></iframe>`;
      else modalBodyEl.innerHTML = '<p style="padding:20px;text-align:center;">Kh√¥ng xem tr∆∞·ªõc ƒë∆∞·ª£c ƒë·ªãnh d·∫°ng n√†y.</p>';
      modal.style.display = "block";
    }

    closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = e => { if (e.target == modal) modal.style.display = "none"; };
  </script>
</body>
</html>
