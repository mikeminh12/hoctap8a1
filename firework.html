<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ† Xem PhÃ¡o Hoa Giao Thá»«a</title>
<style>
  html, body { margin: 0; padding: 0; background: black; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
  canvas { display: block; width: 100vw; height: 100vh; }

  #title {
    position: fixed; top: 20px; width: 100%; text-align: center;
    color: #ffeb3b; text-shadow: 0 0 10px red; z-index: 10; pointer-events: none;
  }

  #countdownBox {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7); color: #ffeb3b; padding: 12px 24px;
    border-radius: 50px; font-size: 18px; font-weight: bold; z-index: 20;
    border: 1px solid #444; backdrop-filter: blur(5px);
  }

  #viewerBox {
    position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.7);
    color: white; padding: 15px; border-radius: 12px; font-size: 14px;
    z-index: 20; min-width: 150px; border: 1px solid #333;
  }
  .viewer-count { color: #4caf50; font-weight: bold; border-bottom: 1px solid #444; margin-bottom: 8px; padding-bottom: 5px; }
  #viewerList { max-height: 150px; overflow-y: auto; }
</style>
</head>
<body>

<div id="title">
  <h1>CHÃšC Má»ªNG NÄ‚M Má»šI 2025</h1>
</div>

<div id="viewerBox">
  <div class="viewer-count">ğŸ‘¥ Äang xem: <span id="count">0</span></div>
  <div id="viewerList"></div>
</div>

<div id="countdownBox">
  <span id="cdText">Äang táº£i tÃ­n hiá»‡u...</span>
</div>

<canvas id="canvas"></canvas>

<script type="module">
  import { db, rtdb, auth, ref, set, onValue, onDisconnect, doc, onSnapshot, getDoc } from "./firebase.js";

  const cdText = document.getElementById("cdText");
  const countSpan = document.getElementById("count");
  const viewerList = document.getElementById("viewerList");

  // 1. Láº¤Y Ká»ŠCH Báº¢N VÃ€ CHáº Y PHÃO HOA
  onSnapshot(doc(db, "events", "tet_firework"), (snap) => {
    if (!snap.exists()) return;
    const data = snap.data();
    
    const timer = setInterval(() => {
      const now = Date.now();
      const diff = data.time - now;

      if (diff <= 0) {
        clearInterval(timer);
        cdText.innerText = "ğŸ† CHÆ¯Æ NG TRÃŒNH ÄANG DIá»„N RA ğŸ†";
        if (window.runFireworkScript && !window.isPlaying) {
          window.runFireworkScript(data.script);
        }
      } else {
        const s = Math.floor(diff / 1000);
        const m = Math.floor(s / 60);
        cdText.innerText = `ğŸ† Báº¯t Ä‘áº§u sau: ${m}:${(s % 60).toString().padStart(2, '0')}`;
      }
    }, 1000);
  });

  // 2. Há»† THá»NG NGÆ¯á»œI XEM (FIX Lá»–I PERMISSION)
  auth.onAuthStateChanged(async (user) => {
    if (!user) return;

    // Láº¥y tÃªn tá»« Firestore (náº¿u cÃ³) hoáº·c dÃ¹ng máº·c Ä‘á»‹nh
    let displayUsername = "NgÆ°á»i xem áº©n danh";
    try {
      const uSnap = await getDoc(doc(db, "users", user.uid));
      if(uSnap.exists()) displayUsername = uSnap.data().username;
    } catch(e) { console.log("DÃ¹ng tÃªn máº·c Ä‘á»‹nh"); }

    const myViewRef = ref(rtdb, 'viewers/' + user.uid);
    
    // Ghi Ä‘Ã¨ Ä‘á»ƒ bÃ¡o hiá»‡u Ä‘ang online
    set(myViewRef, { 
      name: displayUsername, 
      at: Date.now() 
    }).catch(err => console.error("Lá»—i Rules: ", err));

    // Tá»± Ä‘á»™ng xÃ³a khi thoÃ¡t
    onDisconnect(myViewRef).remove();

    // Láº¯ng nghe danh sÃ¡ch ngÆ°á»i xem
    onValue(ref(rtdb, 'viewers'), (snap) => {
      const viewers = snap.val() || {};
      const keys = Object.keys(viewers);
      countSpan.innerText = keys.length;
      viewerList.innerHTML = keys.map(k => `<div style="margin-bottom:3px">ğŸ‘¤ ${viewers[k].name}</div>`).join('');
    });
  });
</script>

<script src="firework.js"></script>
</body>
</html>